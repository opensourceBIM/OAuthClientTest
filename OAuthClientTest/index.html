<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OAuth Client Test</title>
<link href="css/bootstrap.min.css" rel="stylesheet">
<link rel="icon" type="image/png" href="img/sport_raquet.png">
</head>
<body>
	<div class="well">
		This small test application should redirect to your BIMserver, ask for authentication, return to this site and then use the given authentication to access a BIMserver project and show some details.
	</div>
	<div class="container">
		BIMserver Address
		<input class="form-control endpointInp" placeholder="http://localhost:8080"/>
		<button class="btn btn-primary btnBegin">Begin</button>
	</div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
</body>
<script>

function post(url, data, callback, errorCallback) {
	var settings = {
		contentType: "application/json",
		type: "POST",
		data: JSON.stringify(data)
	};
	$.ajax(url, settings).done(function(data) {
		callback(data);
	  })
	  .fail(function() {
	    console.error("login");
	  });
}

var QueryString = function () {
	  // This function is anonymous, is executed immediately and 
	  // the return value is assigned to QueryString!
	  var query_string = {};
	  var query = window.location.search.substring(1);
	  var vars = query.split("&");
	  for (var i=0;i<vars.length;i++) {
	    var pair = vars[i].split("=");
	        // If first entry with this name
	    if (typeof query_string[pair[0]] === "undefined") {
	      query_string[pair[0]] = decodeURIComponent(pair[1]);
	        // If second entry with this name
	    } else if (typeof query_string[pair[0]] === "string") {
	      var arr = [ query_string[pair[0]],decodeURIComponent(pair[1]) ];
	      query_string[pair[0]] = arr;
	        // If third or later entry with this name
	    } else {
	      query_string[pair[0]].push(decodeURIComponent(pair[1]));
	    }
	  } 
	  return query_string;
	}();

if (QueryString.code != null) {
	var oauthCode = QueryString.code;
	var bimServerAddress = QueryString.address;
	var poid = QueryString.poid;
	post(bimServerAddress, {
		oauthcode: oauthCode,
		request: {
			interface: "ServiceInterface",
			method: "getProjectByPoid",
			arguments: {
				poid: poid
			}
		}
	}, function(response){
		console.log(response);
	});
}

$(".btnBegin").click(function(){
	var baseUrl = $(".endpointInp").val();
	post(baseUrl + "/oauth/register", {
		redirect_url: document.location.href,
		client_name: "test",
		client_description: "test",
		client_icon: "test",
		client_url: "test",
		type: "pull"
	}, function(response){
		var json = JSON.parse(response);
		document.location = baseUrl + "/oauth/" + "?redirect_uri=" + document.location + "&response_type=code&client_id=" + json.client_id;
	});
});
</script>
</html>