<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>OAuth Client Test</title>
<link href="css/bootstrap.min.css" rel="stylesheet">
<link rel="icon" type="image/png" href="img/image_link.png">
</head>
<body>
	<div class="well">
		This small test application should redirect to your BIMserver, ask for authentication, return to this site and then use the given authentication to access a BIMserver project and show some details.
	</div>
	<div class="container">
		<div class="initial">
			BIMserver Address
			<input class="form-control endpointInp" placeholder="http://localhost:8080"/>
			<button class="btn btn-primary btnBegin">Begin</button>
		</div>
		<div class="projectDetails">
		
		</div>
	</div>
	<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.11.3/jquery.min.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="js/utils.js"></script>
</body>
<script>

if (QueryString.code != null) {
	var oauthCode = QueryString.code;
	var bimServerAddress = QueryString.address;
	var poid = QueryString.poid;
	post(bimServerAddress, {
		oauthcode: oauthCode,
		request: {
			interface: "ServiceInterface",
			method: "getProjectByPoid",
			parameters: {
				poid: poid
			}
		}
	}, function(response){
		var project = response.response.result;
		$(".initial").hide();
		$(".projectDetails").append("Project name: " + project.name);
	});
}

$(".btnBegin").click(function(){
	var baseUrl = $(".endpointInp").val();
	
	var getUrl = window.location;
	var clientBaseUrl = getUrl.protocol + "//" + getUrl.host + getUrl.pathname;
	
	var iconUrl = clientBaseUrl + "img/image_link.png";
	
	post(baseUrl + "/oauth/register", {
		redirect_url: document.location.href,
		client_name: "test",
		client_description: "test",
		client_icon:  iconUrl,
		client_url: "test",
		type: "pull"
	}, function(response){
		var json = JSON.parse(response);
		document.location = baseUrl + "/oauth/" + "?redirect_uri=" + document.location + "&response_type=code&client_id=" + json.client_id + "&auth_type=singleproject";
	});
});
</script>
</html>